---

---

<!--documentclass: science/custom/PG2018/egpubl-->

# 基于深度卷积网络的端到端SPH流体仿真

## 摘要

基于N-S方程的高效仿真一直在数值计算上耗费巨大的计算资源，近来一些利用机器学习方法加速流体仿真的方法也陆续被提出来，但是我们发现，很多方法都是采用卷积网络对欧拉方法进行驱动仿真，这些方法都无法针对SPH方法中离散粒子数据的处理，因而我们提出一种端到端的自动提取离散粒子特征的深度学习框架，驱动仿真场景中每一帧中每一个粒子的加速度，我们称其为PointConvNet。借鉴在3-D目标检测应用中对点云数据的处理，摒弃大多数粒子法使用的手动提取粒子特征的方式，将单个粒子作为一个智能体（agent），提出一种将SPH粒子分组到固定体元，使用全卷积网络进行特征提取，学习场景中粒子的平移，旋转及排列不变性，建模N-S方程中各项单独的力和约束条件， 驱动每一个智能体的加速度。

## 介绍

> 记得锁定主题目标SPH方法
>
> 既然简化的邻居粒子的查找过程，粒子压强力及合力以及最终加速度的计算过程，那么也需要说明最终驱动出的加速度是如何保证一定置信度的，仅仅以预测对加速度的拟合似乎是不行，以现有的结构为基础是可以进行更多探索的。
>
> 边界条件处理
>
> 目前的网络结构中也没有到不可压缩条件进行处理，通过保持密度不变来保证不可压缩性
>
> 目标函数添加动态的时间步长的相关因子以降低过拟合；
>
> 如何说明提取的特征是构建N-S方程的各项约束力；
>
> **流体仿真的主要瓶颈在于为了保证仿真的稳定性和真实性，对时间步长有着严格的限制，SPH并不直接处理不可压缩条件，而是通过保持密度不变来保证不可压缩性，这和欧拉法求解泊松方程矫正速度达到相同的目的，目前比较常用的方法是预测矫正模式迭代更新压强来满足不可压缩限制。**

基于物理的流体模拟的任务是对流体进行数值模拟并生成流体动画，它与流体的数值计算，即计算流体力学（Computational Fluid Dynamic,CFD）在数学表达上看似相近，但二者有显著区别，前者作为计算机动画的分支，追求的是逼真的画面效果和计算效率，后者作为数值计算的分支追求的是计算精度。几乎所有的流体模拟任务和CFD问题的根本基础都是Navier-Stokes方程。有两类主要的计算方法来模拟这些方程：欧拉方法和拉格朗日方法。欧拉方法将空间离散化为固定不动的网格，通过差分近似将偏微分方程在空间上离散到网格网点，从而计算得到流体的各个物理量；拉格朗日方法，则对流体质点进行离散化，通常是用粒子来代表流体微元，通过计算粒子间相互作用来模拟流体[@Bridson:2011uy]，其中比较有代表性的是光滑粒子流体动力学(Smoothed-particle hydrodynamics,SPH)方法。

<!-- 简要介绍sph方法的主要过程。-->

SPH方法中空间内每个点的物理状态都可以由离散粒子使用光滑核函数进行插值表示，将插值应用于密度场和压强场过程中所需要的邻居粒子查找及计算过程，其次就是为保证不可压缩性进行的动态调整。

近来随着机器学习的流行，以及深度学习在不同领域都取得突破性进展，尤其是针对欧拉方法，出现了很多应用卷积网络来求解压力投影以加速模拟的方法。但是这些方法之所以会选择欧拉法进行探索，一方面是因为卷积网络在类图像数据的处理上，有着卓越的效果，另一方面，欧拉法的空间划分使得数据稳定，正好可以适用于卷积网络，二者相互结合，产生了一些结果比较优秀的驱动仿真方法，但是这些方法都回避了对于粒子法仿真数据的处理。

SPH方法的数据具有这样几个特点：首先，流体被粒子化，每个粒子便成为一个单独的个体，粒子运动后，数据随机离散；其次，不同仿真场景，即使整体仿真空间不变，但场景内的粒子数目变化不定，仿真过程中也会出现粒子的增加和减少；第三，尽管粒子的输入顺序不同，但表达的仍然是同一个场景。目前，处理SPH的机器方法很少，目前唯一的面向SPH方法的随机森林方法也是基于手动提取的基于上下文积分特征，并且需要在庞大的集群上进行训练，在一般的环境下并不容易实现，并且手工提取特征的方式在实践过程中，当特征维度很大时，针对每个仿真场景中的所有粒子都进行积分特征的提取，即便常量计算时间，如果不是特大集群进行并行化计算，一个只有几万个粒子的仿真场景，这样的时间消耗其实也是很难忽略不计的，但场景复杂，粒子数目增加，手工提取特征就变得难以接受。

我们探索了一种端到端的自动提取离散粒子特征的深度学习框架，将离散的空间粒子，划分到整齐排列的空间网体中，同时设计网体特征表示层，保证粒子的排列不变性（permutation invariance），之后采用深度全卷积网络提取特征表示粒子在N-S方程中受到的各项力和约束，从而近似得到每一个粒子的加速度。



## 相关工作

>从SPH方法的演变开始，聚焦传统基于物理的SPH方法主要解决的问题，这一部分应该还是要简化，直接从机器学习和模式识别的角度探索与流体动力学的结合，以及后期深度学习与流体动力学的结合。

液体是最为常见的流体，这类流体似乎是不可压缩的，要想得到逼真的液体效果，不可压缩性非常关键。早期的SPH流体模拟方法采用理想气体方程，视觉上有很强的压迫感[28，38]。Monaghan以及Becker等人使用Tait方程取代理想气体状态方程，并使用硬度很高的控制系数[36,39]，被称为WCSPH(Weakly Compressile SPH),WCSPH显著增加了模拟的真实性，但这是以限制时间步长为代价的，从而影响了算法运行效率。很多学者以提高算法运行效率为目标，提出了很多改进算法。Solenthaler等人提出的PCISPH（Predictive-Corrective Incompressible SPH）方法颇具代表性[14]，PCISPH算法能够设置全局最大密度波动，用预测矫正的迭代过程实现流体的不可压缩性，该算法解除了WCSPH中对时间步长的限制，将算法的整体效率提高为原来的10-50倍 。



> 这确实是一个非常新奇的观点，将粒子作为智能体，去建模在不同交互场景下粒子应该有的表现，那么针对每一帧的每一个粒子，我们的聚焦点也是通过场景内的所有粒子信息，提取不同尺度的特征，来建模这一个粒子。

近几年基于机器学习的方法被广泛应用于流体模拟。Yang等提出使用人工神经网络的数据驱动投影方法来避免欧拉方法的迭代计算，显著提升了欧拉方法中为保证不可压缩性求解Poisson方程时投影步骤的计算时间[@Yang:2016he]。（因为有一个结论是在设计上保证的某项性质，比如平移不变性，所能保证的仅仅是在更少的数据量上学习到某项性质，在更大的数据量上，即便没有这种结构，只要模型具有一定量的复杂度，能够承载更大的数据量，便也能学习到这种性质，那么是否就表明机器学习在这部分就仅仅起近似功能。）

- [ ] 那么将机器学习应用于流体模拟，除了是一种牺牲一定精度换取效率提升的在**基于物理仿真方法**之上的数值近似外，是否还有别的意义。
- [ ] 邻居粒子信息的表达
- [ ] Permutation-equivariant

在深度学习广泛流行之前，已经有一些模式识别与流体模拟结合的讨论与探索。Eraldo[@Marinho:2014dh]指出，当包括各项异性检测提高shock layer（冲击层）的分辨率时，SPH是无监督学习的一个非常特殊的问题。另外一点非常有意思，SPH的自由粒子的本质为人工智能在协作框架中研究粒子作为智能体提供了机会，在协作框架中，流体仿真的结果作为一个学习知识库。同样的，为了使算法不依赖于输入数据的特定顺序，一些对排列等变的网络结构也被设计出来。

Guttenberg等[@Guttenberg:wsa]提出了一种类比卷积层的排列等变神经网络层。

针对点云的数据处理上，在流体模拟领域并此没有涉及，甚至于在机器学习领域也很少有工作涉及，不过近期在3-D目标检测领域，提出了几种点云数据的处理方式。Charles等[@{Qi:2016vq}]提出针对3D点云数据的分类和分割深度学习框架PointNet，直接处理点云数据并且能很好的检测出输入数据的排列不变性。在PointNet之后，Charles等[@Qi:2017tf]针对PointNet无法捕获局部结构的缺陷，进一步提出PointNet++，一个递归应用PointNet的分层神经网络(metrix space?),通过利用度量空间的距离，网络可以通过增加上下文尺度来学习本地特征。Zhou[@Zhou:2017vn]等提出应用于3D点云数据的端到端深度学习框架VoxelNet，基于激光雷达扫描的3D数据进行目标类别检测及边界框预测。





## 引用

 Deep learning in fluid dynamics 

https://github.com/loliverhennigh/Computational-Physics-and-Machine-Learning-Reading-List

## 讨论

from reddit and stackoverflow

从 Computational Fluid Dynamics分类开始，交代欧拉方法和SPH方法在传统CFD领域所处的位置， proper  orthogonal  decomposition  or  dynamic  mode  decomposition（正交分解，动态模态分解，奇异值分解）



通过在大数据集上大量的计算，深度网络可以很好处理多尺度特征，平移、旋转和不变性。

建立各项异性张量（anisotropy tensor）各项异性特征值（anisotropy  eigenvalues）

旋转不变性

 Rotational  invariance  signifies  that  the  physics  of  the  fluid  flow does  not  depend  on  the  orientation  of  the  coordinate  frame  of  the  observer. 

旋转不变性表明流体的物理性质不依赖于观察者的坐标系的方向

虽然很多创新来源于物理可解释的模型，DNN建立起比传统计算更优性能的预测模型，但没有提供足够的证据来说明为什么要这样建立模型。



- [ ] 寻找一种可以根据问题的特性，来定义适当的离散化（appropriate discretization），空间和时间差异模式，初始条件和解决方法的通用方法。

      在每个方法中，问题决定了模型，模型决定了离散化，离散化确定求解器

- [ ] 一个高清晰度的解决方案，加上机器学习技术，是否可以用来定制一个步长大得多但仍然保持收敛性、准确性等的差异方案。

ML基于观测数据选择参数，

如果有数学模型可以精确的告诉你如何选择的参数如step size，那么使用ML来确定这些参数是没有意义的。



程序看到物理现象，并产生一个数学模型来预测类似物理模型的反应



## 参考文献